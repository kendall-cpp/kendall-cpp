## 后台组件编程

## 数据库
### 数据库的安装
```
ubuntu MySQL安装
sudo apt-get install mysql-server           
apt-get install mysql-client
sudo apt-get install libmysqlclient-dev
```
启动，停止，重启
```
sudo /etc/init.d/mysql start|stop|restart
```

客户端连接
```
mysql -h127.0.0.1 -uroot -p
```

查看初始密码

`sudo cat /etc/mysql/debian.cnf`
```
[client]
host     = localhost
user     = debian-sys-maint
password = bkj9qQqs2wovUaM1
socket   = /var/run/mysqld/mysqld.sock
[mysql_upgrade]
host     = localhost
user     = debian-sys-maint
password = bkj9qQqs2wovUaM1   #这就是密码
socket   = /var/run/mysqld/mysqld.sock
```

修改密码
```
1)、use mysql;         #连接到mysql数据库

2)、update mysql.user set authentication_string=password('123456') where user='root' and Host ='localhost';    #修改密码123456是密码

3)、update user set  plugin="mysql_native_password";     

4)、flush privileges;

5)、quit; 
```

查看mysql绑定的ip
```
sudo netstat -tap | grep mysql

tcp        0      0 localhost:mysql         0.0.0.0:*               LISTEN      853/mysqld  
```


### mysql 的外部连接

`MySQL`安装后默认是只允许本机访问`MySQL`

可以在`user`表中查看与确认。
```
mysql> select user,host from user;
+------------------+-----------+
| user             | host      |
+------------------+-----------+
| debian-sys-maint | localhost |
| mysql.session    | localhost |
| mysql.sys        | localhost |
| root             | localhost |
+------------------+-----------+
```

update修改其中某一条记录的`host`字段值为`'%'`，或者新增一条记录且`host`字段值为`'%'`。
```
update user set host = ‘%’ where user =’root’;

flush privileges;

quit

mysql> select user,host from user;
+------------------+-----------+
| user             | host      |
+------------------+-----------+
| root             | %         |
| debian-sys-maint | localhost |
| mysql.session    | localhost |
| mysql.sys        | localhost |
+------------------+-----------+
```
如果上面两种情况都不存在或不能解决，可以使用 `netstat` 命令查看 `mysql` 服务绑定的 `ip`， 如果绑定的是 `127.0.0.1`，则外部机器也不能访问 `mysql`。可以通过修改 `Mysql` 配置文件解决。 以 Ubuntu 系统为例，使用 `apt-get` 方式安装的 `Mysql`，配置文件默认位置通常是 `/etc/mysql/mysql.conf.d/mysqld.cnf`

```
sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf

注释掉以下一行即可:
#bind-address           = 127.0.0.1
```

Mysql重启 
`sudo /etc/init.d/mysql restart`

### mysql 的字符集

### libmysql 的开发环境
ubuntu 下安装libmysql           
`sudo apt-get install libmysqlclient-dev`

`sudo apt-get install libmysql++-dev`

拷贝lib：           
`sudo  cp /usr/lib/mysql/plugin /usr/lib/ -a`

编译执行            
`g++ mysql_test.cpp -Lmysql.h -lmysqlclient`

- 测试代码
```js
#include <stdio.h>
#include <iostream>
#include "/usr/include/mysql/mysql.h"
using namespace std;
int main() {
    MYSQL *conn_ptr;
    conn_ptr = mysql_init(NULL);  //初始化
    //"root":数据库管理员 "123":root密码 "test":数据库的名字
    conn_ptr = mysql_real_connect(conn_ptr, "localhost", "root", "123456","lingsheng-test", 0, NULL, 0);//连接数据库 1则success or failed
    if (conn_ptr) {
        cout << "connect success" << endl;
    } else {
        cout << "connect failed" << endl;
    }
    return 0;
}
```
- 使用C++调用MySQL API进行增删改查
```js
//#include <WinSock.h>  //windows需要添加这个头文件
#include <stdio.h>
#include <iostream>
#include "/usr/include/mysql/mysql.h"
#include "mysql/mysql.h"
#include <string>
using namespace std;

MYSQL *mysql;  //mysql连接
MYSQL_FIELD *fd;  //字段列数组
char field[32][32];  //存字段名二维数组
MYSQL_RES *res;     ////这个结构代表返回行的一个查询结果集
MYSQL_ROW column;   //一个行数据的类型安全的表示，表示数据行的列
char query[150];   //查询的SQL语句

//函数声明
bool ConnectDatabase();
void FreeConnect();
bool QueryDatabase1();  //查询1
bool QueryDatabase2();  //查询2
bool InsertData();
bool ModifyData();
bool DeleteData();

int main() {
    ConnectDatabase();
    // 查询1
    QueryDatabase1();

    //插入数据
//    InsertData();

    //修改数据
    ModifyData();

    //查询
    QueryDatabase1();

    //删除
    DeleteData();
    QueryDatabase1();

    //释放空间
    FreeConnect();
    return 0;
}
//连接数据库
bool ConnectDatabase() {
    cout << "-------连接模块--------" << endl;
    //初始化mysql
    mysql = mysql_init(NULL);  //连接mysql,数据库

    char server[] = "127.0.0.1";
    char user[] = "root";
    char password[] = "123456";
    char database[] = "lingsheng-test";

    //返回false表示连接失败，返回true表示连接成功
    //中间分别是主机，用户名，密码，数据库名，端口号（可以写默认0或者3306等），可以先写成参数再传进去
    if(!(mysql_real_connect(mysql,server,user,password,database,0,NULL,0))) {
        printf( "Error connecting to database:%s\n",mysql_error(mysql));
        return false;
    }else {
        printf("Connected...\n");
        return true;
    }
}
//释放资源
void FreeConnect() {
    mysql_free_result(res);
    mysql_close(mysql);
}

/***************************数据库操作***********************************/
//其实所有的数据库操作都是先写个sql语句，然后用mysql_query(mysql,query)来完成，包括创建数据库或表，增删改查
//查询数据
bool QueryDatabase1() {
    cout << "-------查询模块--------" << endl;
    sprintf(query,"select * from user_info");  ////执行查询语句，这里是查询所有，user_info是表名，不用加引号，用strcpy也可以
    mysql_query(mysql,"set names gbk");//设置编码格式（SET NAMES GBK也行），否则cmd下中文乱码
    //返回0 查询成功，返回1查询失败
    if(mysql_query(mysql,query)) {
        printf("Query failed (%s)\n",mysql_error(mysql));
        return false;
    } else{
        printf("select success\n");
    }
    //获取结果集
    if (!(res=mysql_store_result(mysql))) {  ////获得sql语句结束后返回的结果集
        printf("Couldn't get result from %s\n", mysql_error(mysql));
        return false;
    }
    //打印数据行数
    int rows = mysql_affected_rows(mysql);
    cout << "the rows is：" << rows << endl;

    char * str_name[20];
    for (int i = 0; i < 3; ++i) {
        str_name[i] = mysql_fetch_field(res)->name;
        cout << str_name[i] << '\t';
    }
    cout << endl;

    //  打印标题

    //打印获取的数据
    while (column = mysql_fetch_row(res)) {
        cout << column[0] << '\t' << column[1] << '\t' << column[2] << endl;
    }
//    cout << column[0] << '\t';
//    cout << column[1] << '\t';
//    cout << column[2] << endl;

    return true;
}
//插入数据
bool InsertData() {
    cout << "-------插入模块--------" << endl;
    sprintf(query,"insert into user_info values(2,'kendall','kendall_title');");
    if(mysql_query(mysql,query)) {
        printf("Query of insert failed (%s)\n",mysql_error(mysql));
        return false;
    }else {
        cout << "insert success..." << endl;
        return true;
    }
}
//修改数据
bool ModifyData() {
    cout << "-------修改模块--------" << endl;
    sprintf(query,"update user_info set title='kendall_title2' where name='kendall'; ");
    if(mysql_query(mysql,query)) {
        cout << "Query of updata failed is " << mysql_error(mysql) << endl;
        return false;
    }else {
        cout << "updata success" << endl;
        return true;
    }
}
//删除数据
bool DeleteData() {
    cout << "-------删除模块--------" << endl;
//    sprintf(query,"delete from user_info where id=2");
    cout << "please input delete sql: " ;
    cin.getline(query,100,'\n');
    if (mysql_query(mysql,query)) {
        cout << "Query of delete failed is " << mysql_error(mysql) << endl;
        return false;
    }else {
        cout << "delete success" << endl;
        return true;
    }

}
```

### MySQL事务

1)在 MySQL 中只有使用了 Innodb 数据库引擎的数据库或表才支持事务。 

2)事务处理可以用来维护数据库的完整性，保证成批的 SQL 语句要么全部执行，要么全部不执行。 

3)事务用来管理 `insert,update,delete` 语句。

事务四大特征: 
- 原子性(Atomicity，或称不可分割性)、 
- 一致性(Consistency)、 
- 隔离性(Isolation，又称独立性)、 多个事务执行时，防止多个事务执行发生交叉执行数据不一致问题
- 持久性(Durability)。


 事务。索引，存储引擎

 ### Nginx
 DNS做负载均衡

 #### Nginx的使用

 Nginx的conf的原理

 


